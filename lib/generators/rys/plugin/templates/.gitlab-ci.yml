stages:
  - linter
  - modifications

# Before_script is used to define the command that should be run before all
# jobs, including deploy jobs, but after the restoration of artifacts. This can
# be an array or a multi-line string.
before_script:
  - export HOME=/home/gitlab-runner
  - export LC_ALL=en_US.UTF-8
  - export RAILS_ENV=test
  - ''
  - rvm use ruby 2.3.3 >/dev/null 2>&1
  - ruby -v

.only: &only
  - master

# -----------------------------------------------------------------------------
# Stage: Linter

Check syntax error:
  stage: linter
  script:
  - $SHELL ruby-linter

MySQL / Modifications:
  variables:
    ADAPTER: mysql2
  stage: modifications
  tags:
  - mysql
  script:
  - ruby ./.dummy_control.rb
  - bundle install --without xapian rmagick
  - rake db:migrate
  - pwd
  - bundle exec rspec

PostgreSQL / Modifications:
  variables:
    ADAPTER: postgresql
  stage: modifications
  tags:
  - postgresql
  script:
  - ruby ./.dummy_control.rb -a postgresql
  - bundle install --without xapian rmagick
  - rake db:migrate
  - pwd
  - bundle exec rspec

